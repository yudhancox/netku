<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><%= shortPlayName %></title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="//unpkg.com/xgplayer@3.0.14/dist/index.min.css">
<script src="//unpkg.com/xgplayer@3.0.14/dist/index.min.js"></script>

<style>
html,body{
  margin:0;
  height:100%;
  background:black;
  overflow:hidden;
}
#player-container{
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  background:black;
  z-index:0;
}
#xgplayer{
  width:100%;
  height:100%;
  background:black;
}
#subtitle{
  position:absolute;
  bottom:80px;
  width:100%;
  text-align:center;
  color:white;
  font-size:18px;
  pointer-events:none;
  z-index:50;
}
#subtitle span{
  background:rgba(0,0,0,0.5);
  padding:4px 8px;
  border-radius:4px;
}

/* overlay episode controls */
.episode-overlay{
  position:absolute;
  top:0;
  right:0;
  left:0;
  bottom:0;
  z-index:60;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  pointer-events:none;
  padding:1rem;
}
.episode-overlay button{
  pointer-events:auto;
  margin-bottom:0.5rem;
  background:rgba(0,0,0,0.5);
  border-radius:9999px;
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:16px;
}
</style>
</head>

<body>

<div id="player-container">
  <div id="xgplayer"></div>
  <div id="subtitle"></div>

  <!-- overlay buttons -->
  <div class="episode-overlay">
    <button onclick="prevEpisode()" title="Prev Ep"><i class="fas fa-arrow-up"></i></button>
    <button onclick="nextEpisode()" title="Next Ep"><i class="fas fa-arrow-down"></i></button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const episodes = <%- JSON.stringify(episodes) %>;
let currentIndex = episodes.findIndex(e=>e.episodeNo==<%= selectedEpisode.episodeNo %>);
let player;

function initPlayer(url,poster,sub){
 if(player){player.destroy();player=null}
 document.getElementById("xgplayer").innerHTML="";
 player=new Player({
   id:"xgplayer",
   url,
   poster,
   autoplay:true,
   muted:true,
   playsinline:true,
   controls:true,
   videoInit:true
 });
 if(sub) loadSubtitle(sub);
 player.on("ended",()=>nextEpisode());
}

let subs=[];
function loadSubtitle(url){
 fetch(url).then(r=>r.text()).then(vtt=>{
  subs=[];
  const p=/(\d+:\d+:\d+\.\d+)\s-->\s(\d+:\d+:\d+\.\d+)\s([\s\S]*?)(?=\n\n|$)/g;
  let m;
  while(m=p.exec(vtt)){
    subs.push({s:toSec(m[1]),e:toSec(m[2]),t:m[3].replace(/\n/g,"<br>")});
  }
 });
 player.on("timeupdate",()=>{
  const t=player.currentTime;
  const c=subs.find(s=>t>=s.s&&t<=s.e);
  document.getElementById("subtitle").innerHTML=c?`<span>${c.t}</span>`:"";
 });
}
function toSec(t){ const [h,m,s]=t.split(":"); return +h*3600+ +m*60+parseFloat(s); }

function playEpisode(i){
 if(i<0||i>=episodes.length)return;
 currentIndex=i;
 location.href=`/api/drama/<%= id %>/`+episodes[i].episodeNo;
}
function nextEpisode(){ playEpisode(currentIndex+1); }
function prevEpisode(){ playEpisode(currentIndex-1); }

/* swipe */
let startY=0;
document.addEventListener("touchstart",e=>{ startY=e.touches[0].clientY; });
document.addEventListener("touchend",e=>{
 let endY=e.changedTouches[0].clientY;
 let diff=startY-endY;
 if(Math.abs(diff)>80){ diff>0?nextEpisode():prevEpisode(); }
});

/* double click fullscreen */
document.addEventListener("dblclick",()=>{
 const el=document.documentElement;
 if(!document.fullscreenElement){ el.requestFullscreen(); }
 else{ document.exitFullscreen(); }
});

initPlayer("<%- playVoucher %>","<%- shortPlayCover %>","<%- subtitleUrl||'' %>");

});
</script>

</body>
</html>
