<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><%= shortPlayName %></title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="//unpkg.com/xgplayer@3.0.14/dist/index.min.css">
<script src="//unpkg.com/xgplayer@3.0.14/dist/index.min.js"></script>

<style>
html,body{
    margin:0;
    padding:0;
    height:100%;
    background:#000;
    overflow:hidden;
}
#player-wrapper{
    position:fixed;
    inset:0;
    background:#000;
}
#xgplayer{
    width:100%;
    height:100%;
}
#subtitle{
    position:absolute;
    bottom:80px;
    width:100%;
    text-align:center;
    z-index:50;
    pointer-events:none;
}
.episode-card.active{
    background:#ec4899;
    color:#fff;
    font-weight:bold;
}
</style>
</head>

<body>

<!-- FULLSCREEN PLAYER -->
<div id="player-wrapper">
    <div id="xgplayer"></div>
    <div id="subtitle" class="text-white text-lg font-semibold"></div>

    <!-- OPEN EPISODE -->
    <button id="openEpisode"
        class="absolute right-3 bottom-24 z-50 bg-black/60 text-white px-3 py-2 rounded">
        Episode
    </button>
</div>

<!-- EPISODE PANEL -->
<div id="episodePanel"
     class="fixed bottom-0 left-0 right-0 h-[45%] bg-white z-[100]
            translate-y-full transition-transform duration-300">
    <div class="p-3 flex justify-between items-center border-b">
        <b>Episode</b>
        <button id="closeEpisode">Tutup</button>
    </div>
    <div class="p-3 grid grid-cols-5 gap-2 overflow-y-auto h-full">
        <% episodes.forEach((ep,i)=>{ %>
        <button
            class="episode-card border rounded p-2 text-sm"
            data-index="<%= i %>"
            data-url="<%= ep.playUrl %>">
            Ep <%= ep.episodeNo %>
        </button>
        <% }) %>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

let player=null;
let currentIndex=0;
const episodes=[...document.querySelectorAll(".episode-card")];

/* INIT PLAYER */
function initPlayer(index){
    if(!episodes[index]) return;
    currentIndex=index;

    episodes.forEach(b=>b.classList.remove("active"));
    episodes[index].classList.add("active");

    if(player) player.destroy();

    player=new Player({
        id:"xgplayer",
        url:episodes[index].dataset.url,
        autoplay:true,
        muted:true,
        playsinline:true,
        fullscreen:true
    });

    // AUTO NEXT
    player.on("ended",()=>nextEpisode());
}

/* FIRST LOAD */
initPlayer(0);

/* NEXT / PREV */
function nextEpisode(){
    if(currentIndex < episodes.length-1){
        initPlayer(currentIndex+1);
    }
}
function prevEpisode(){
    if(currentIndex > 0){
        initPlayer(currentIndex-1);
    }
}

/* EPISODE PANEL */
const panel=document.getElementById("episodePanel");
document.getElementById("openEpisode").onclick=()=>{
    panel.style.transform="translateY(0)";
};
document.getElementById("closeEpisode").onclick=()=>{
    panel.style.transform="translateY(100%)";
};

/* CLICK EPISODE */
episodes.forEach(btn=>{
    btn.onclick=()=>{
        initPlayer(parseInt(btn.dataset.index));
        panel.style.transform="translateY(100%)";
    };
});

/* SWIPE UP / DOWN */
let startY=0;
let endY=0;

document.addEventListener("touchstart",e=>{
    startY=e.touches[0].clientY;
});

document.addEventListener("touchend",e=>{
    endY=e.changedTouches[0].clientY;
    let diff=startY-endY;

    if(Math.abs(diff)>60){
        if(diff>0){
            nextEpisode();   // swipe up
        }else{
            prevEpisode();   // swipe down
        }
    }
});

/* FORCE FULLSCREEN */
setTimeout(()=>{
    const el=document.documentElement;
    if(el.requestFullscreen){
        el.requestFullscreen().catch(()=>{});
    }
},800);

});
</script>

</body>
</html>
